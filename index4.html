<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebGIS - WMS Highlight & Info Table</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css" />
<script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>

<link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@4.1.0/dist/ol-layerswitcher.css" />
<script src="https://unpkg.com/ol-layerswitcher@4.1.0"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ol-proj4@6.4.0/dist/ol-proj4.js"></script>

<style>
html, body { margin:0; padding:0; width:100%; height:100%; direction:rtl; font-family:Tahoma,sans-serif; }
#container { width:100%; height:100%; }
.ol-control.ol-layerswitcher { top:5px; right:1em; left:auto; bottom:auto; }
.ol-popup {
  position:absolute;
  background:white;
  padding:10px;
  border:1px solid #333;
  border-radius:5px;
  min-width:200px;
  max-width:300px;
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
  font-size:13px;
}
table { border-collapse: collapse; width:100%; }
th, td { border:1px solid #ccc; padding:5px; text-align:right; }
th { background:#f0f0f0; }
    
.layer-switcher {
            position: absolute;
            top: 0.5em;
            right: 0.5em;
            text-align: left;
        }
    
</style>
</head>
<body>
<div id="container"></div>
<div id="popup" class="ol-popup"></div>

<script>
proj4.defs("EPSG:32639","+proj=utm +zone=39 +datum=WGS84 +units=m +no_defs");
ol.proj.proj4.register(proj4);

// لایه‌های پایه
var osmLayer = new ol.layer.Tile({ title:'OpenStreetMap', type:'base', visible:true, source:new ol.source.OSM() });
var googleHybrid = new ol.layer.Tile({ title:'Google Hybrid', type:'base', visible:false, source:new ol.source.XYZ({ url:'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', crossOrigin:'anonymous' }) });
var baseGroup = new ol.layer.Group({ title:'Base maps', layers:[osmLayer, googleHybrid] });

// لایه‌های WMS
var wmsLayer1 = new ol.layer.Tile({
  title:'txt1402_13066', visible:false,
  source:new ol.source.TileWMS({
    url:'http://192.168.1.158:9090/geoserver1/webgis/wms',
    params:{ LAYERS:'webgis:txt1402_13066', TILED:true, VERSION:'1.1.0', FORMAT:'image/png' },
    serverType:'geoserver', crossOrigin:'anonymous'
  })
});
var wmsLayer2 = new ol.layer.Tile({
  title:'blk1402_1306', visible:false,
  source:new ol.source.TileWMS({
    url:'http://192.168.1.158:9090/geoserver1/webgis/wms',
    params:{ LAYERS:'webgis:blk1402_1306', TILED:true, VERSION:'1.1.0', FORMAT:'image/png' },
    serverType:'geoserver', crossOrigin:'anonymous'
  })
});

// لایه هایلایت
var highlightLayer = new ol.layer.Vector({
  source: new ol.source.Vector(),
  style: new ol.style.Style({
    stroke: new ol.style.Stroke({ color:'yellow', width:3 }),
    fill: new ol.style.Fill({ color:'rgba(255,255,0,0.3)' })
  })
});

// نقشه
var map = new ol.Map({
  target:'container',
  layers:[baseGroup, wmsLayer1, wmsLayer2, highlightLayer],
  view:new ol.View({ projection:'EPSG:3857', center:ol.proj.fromLonLat([52.5836,29.5926]), zoom:8 })
});

// LayerSwitcher
var layerSwitcher = new ol.control.LayerSwitcher({ tipLabel:'لایه‌ها' });
map.addControl(layerSwitcher);

// زوم روی extent هنگام روشن شدن
wmsLayer1.on('change:visible', function(){
  if(wmsLayer1.getVisible()){
    var extent1 = [713414.5, 3238293.5, 718206.8125, 3241774.5];
    map.getView().fit(ol.proj.transformExtent(extent1,'EPSG:32639','EPSG:3857'), { size: map.getSize(), maxZoom:18 });
  }
});
wmsLayer2.on('change:visible', function(){
  if(wmsLayer2.getVisible()){
    var extent2 = [713472.1875, 3238240.5, 718616.0, 3241822.0];
    map.getView().fit(ol.proj.transformExtent(extent2,'EPSG:32639','EPSG:3857'), { size: map.getSize(), maxZoom:18 });
  }
});

// Popup
var popup = document.getElementById('popup');

// کلیک روی نقشه
map.on('singleclick', function(evt){
  popup.style.display='none';
  highlightLayer.getSource().clear();
  var viewResolution = map.getView().getResolution();
  
  [wmsLayer1, wmsLayer2].forEach(function(layer){
    if(layer.getVisible()){
      var url = layer.getSource().getFeatureInfoUrl(
        evt.coordinate,
        viewResolution,
        'EPSG:3857',
        { INFO_FORMAT:'application/json' } 
      );
      if(url){
        fetch(url)
          .then(response=>response.json())
          .then(data=>{
            if(data.features && data.features.length>0){
              // هایلایت هندسه
              var format = new ol.format.GeoJSON();
              var features = format.readFeatures(data, { featureProjection:'EPSG:3857' });
              highlightLayer.getSource().addFeatures(features);
              
              // ساخت جدول HTML
              var table = '<table><tr><th>فیلد</th><th>مقدار</th></tr>';
              var props = data.features[0].properties;
              for(var key in props){
                table += '<tr><td>'+key+'</td><td>'+props[key]+'</td></tr>';
              }
              table += '</table>';
              
              popup.innerHTML = table;
              popup.style.display='block';
              popup.style.left = evt.pixel[0] + 'px';
              popup.style.top = evt.pixel[1] + 'px';
            }
          });
      }
    }
  });
});
</script>
</body>
</html>
